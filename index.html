<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Real-Time Interpreter | ScholarBridge</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Firebase & Toss SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://js.tosspayments.com/v1/payment"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #1e1e2e;
            --card-bg: rgba(40, 41, 61, 0.7);
            --text-main: #e2e2e9;
            --text-sub: #a8a8b3;
            --primary: #4c6ef5;
            /* Modern soft blue */
            --accent: #20c997;
            /* Teal for success */
            --premium: #ffc107;
            /* Gold for license */
            --danger: #ff6b6b;
            --gradient-header: linear-gradient(135deg, #4c6ef5, #5c7cfa);
            --sidebar-width: 320px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans KR', -apple-system, system-ui, sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Header --- */
        .app-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .app-title {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .user-controls {
            font-size: 0.85rem;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* --- Main Layout --- */
        .main-wrapper {
            flex: 1;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 80px;
            /* Space for footer */
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- UI Controls --- */
        .lang-group {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr 1fr;
            margin-bottom: 15px;
        }

        @media (max-width: 480px) {
            .lang-group {
                grid-template-columns: 1fr;
            }
        }

        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 0.95rem;
        }

        .camera-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 12px;
        }

        /* --- Video --- */
        .video-box {
            position: relative;
            width: 100%;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
            aspect-ratio: 4/3;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .subtitle-overlay {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            text-align: center;
            padding: 0 20px;
            pointer-events: none;
        }

        .subtitle-text {
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 1.3rem;
            line-height: 1.5;
            display: inline-block;
            backdrop-filter: blur(4px);
        }

        .subtitle-text.interim {
            color: #aaa;
        }

        @media (min-width: 768px) {
            .subtitle-text {
                font-size: 1.8rem;
            }
        }

        /* --- Buttons --- */
        .action-bar {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 20px;
        }

        .btn {
            transition: opacity 0.2s;
        }

        .gallery-item:hover .delete-btn {
            opacity: 1;
        }

        .gallery-empty {
            grid-column: span 3;
            text-align: center;
            padding: 30px;
            color: #555;
            font-size: 0.85em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 8px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .modal-btn.download {
            background: #00ff88;
            color: #0f0f1a;
        }

        .modal-btn.close {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        #captureCanvas {
            display: none;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 700px;
            }

            .subtitle-text {
                font-size: 1.6em;
            }
        }
    </style>
</head>

<body>
    <!-- 1. Header -->
    <header class="app-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <!-- Simple logo icon or just title -->
            <h1 class="app-title">Real-Time Interpreter</h1>
        </div>
        <div class="user-controls">
            <div id="user-info" style="display: none; align-items: center; gap: 8px;">
                <span id="user-email" style="color: var(--accent);"></span>
                <button onclick="logout()"
                    style="background:none; border:1px solid rgba(255,255,255,0.3); color:#ccc; padding:4px 10px; border-radius:6px; cursor:pointer;">Logout</button>
            </div>
            <div id="login-btn" style="display: block;">
                <!-- Login button can be here or handled by modal -->
            </div>
        </div>
    </header>

    <!-- 2. Right Sidebar (License) -->
    <aside class="license-sidebar" id="licenseSidebar">
        <div class="license-toggle" onclick="toggleSidebar()">ğŸ’</div>
        <h3 style="margin-bottom: 20px; color: var(--premium);">Unleash Full Power</h3>
        <p style="font-size: 0.85rem; color: #ccc; margin-bottom: 20px; line-height: 1.5;">
            Upgrade to premium for unlimited translation and advanced features.
        </p>

        <button class="plan-btn plan-personal" onclick="requestPayment(100000, 'ê°œì¸ ë¼ì´ì„ ìŠ¤')">
            Personal License
            <span>100,000 KRW / Lifetime</span>
        </button>

        <button class="plan-btn plan-lab" onclick="requestPayment(700000, 'ì—°êµ¬ì‹¤ ë‹¨ì²´ íŒ¨í‚¤ì§€')">
            Lab Package
            <span>700,000 KRW / 10 Users (30% OFF)</span>
        </button>

        <div style="margin-top: 20px; font-size: 0.75rem; color: #999; text-align: center;">
            * Instant license activation
        </div>
    </aside>

    <!-- 3. Main Content -->
    <main class="main-wrapper">
        <div class="warning" id="warning">âš ï¸ Please use Chrome or Edge browser.</div>

        <!-- Settings Card -->
        <section class="card">
            <div class="card-title">ğŸŒ Language & Camera</div>
            <div class="lang-group">
                <div>
                    <label style="font-size: 0.8rem; color:#aaa; margin-bottom: 5px; display:block;">Recognition
                        (Input)</label>
                    <select id="recognitionLang">
                        <option value="en-US">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="ko-KR">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="ja-JP">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="id-ID">ğŸ‡®ğŸ‡© Indonesia</option>
                        <option value="vi-VN">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                        <option value="th-TH">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                        <option value="de-DE">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="fr-FR">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="es-ES">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="ru-RU">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="it-IT">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="pt-PT">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                    </select>
                </div>
                <div>
                    <label style="font-size: 0.8rem; color:#aaa; margin-bottom: 5px; display:block;">Translation
                        (Output)</label>
                    <select id="translateLang">
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="id">ğŸ‡®ğŸ‡© Indonesia</option>
                        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                        <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                    </select>
                </div>
            </div>

            <div class="camera-controls">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.9rem;">ğŸ“· Camera</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="cameraToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <select id="cameraFacing" style="width: auto; padding: 8px; font-size: 0.85rem;">
                    <option value="environment">Back Camera</option>
                    <option value="user">Front Camera</option>
                </select>
            </div>
        </section>

        <!-- Video & Subtitle Section -->
        <section class="video-box" id="videoWrapper">
            <video id="videoElement" autoplay playsinline></video>
            <div class="subtitle-overlay">
                <div class="subtitle-text empty" id="subtitleText">Press Start button</div>
            </div>

            <!-- Status Overlay -->
            <div
                style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; display: flex; align-items: center; gap: 8px;">
                <div class="status-dot" id="statusDot"
                    style="width: 8px; height: 8px; border-radius: 50%; background: #666;"></div>
                <span id="statusText" style="font-size: 0.8rem; color: #fff;">Ready</span>
            </div>
        </section>

        <!-- Action Buttons -->
        <div class="action-bar">
            <button class="btn btn-primary" id="startBtn" onclick="startAll()">â–¶ Start</button>
            <button class="btn btn-stop" id="stopBtn" onclick="stopAll()" style="display: none;">â¹ Stop</button>
            <button class="btn btn-capture" onclick="captureWithSubtitle()">ğŸ“¸ Capture</button>
            <button class="btn btn-log" onclick="saveTranscript()">ğŸ’¾ Save</button>
            <button class="btn btn-secondary" onclick="clearTranscript()">ï¿½ Clear</button>
        </div>

        <!-- Transcript & Gallery -->
        <section class="card">
            <div class="card-title">ğŸ“ Live Transcript</div>
            <div class="log-box" id="transcriptBox"></div>
        </section>

        <section class="card">
            <div class="card-title">
                ğŸ–¼ Gallery <span id="captureCount" style="margin-left: 5px; font-size: 0.8rem; opacity: 0.7;">(0)</span>
                <button onclick="clearGallery()"
                    style="margin-left: auto; background: none; border: none; color: #aaa; cursor: pointer; font-size: 0.8rem;">Clear
                    All</button>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <div class="gallery-empty" style="flex: 1; text-align: center; color: #666; padding: 20px;">No captures
                    yet</div>
            </div>
        </section>
    </main>

    <!-- 4. Footer -->
    <footer class="app-footer">
        <img src="logo.jpg" alt="ScholarBridge Logo" class="footer-logo">
        <div class="footer-company">ScholarBridge</div>
        <p class="footer-text">Sinbong 2-ro, Suji-gu, Yongin-si, Gyeonggi-do</p>
        <p class="footer-text" style="color: #666; font-size: 0.75rem; margin-top: 10px;">Â© 2026 ScholarBridge. All
            rights reserved.</p>
    </footer>

    <div class="toast" id="toast"></div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="card" style="width: 90%; max-width: 400px; background: rgba(15, 15, 26, 0.95);">
            <div class="card-title">ğŸ” Login Required</div>
            <p style="color: #ccc; margin-bottom: 20px; font-size: 0.9em;">
                This service requires a valid license. Please login to continue.
            </p>
            <button class="btn btn-primary" onclick="loginWithGoogle()" style="width: 100%;">
                Login with Google
            </button>
        </div>
    </div>
    <div class="modal" id="imageModal">
        <img id="modalImage" src="" alt="Captured image">
        <div class="modal-buttons">
            <button class="modal-btn download" onclick="downloadModalImage()">ğŸ’¾ Download</button>
            <button class="modal-btn close" onclick="closeModal()">âœ• Close</button>
        </div>
    </div>
    <canvas id="captureCanvas"></canvas>

    <!-- Toss Payments SDK -->
    <script src="https://js.tosspayments.com/v1/payment"></script>

    <script>
        // --- UI Interactions ---
        function toggleSidebar() {
            const sidebar = document.getElementById('licenseSidebar');
            sidebar.classList.toggle('open');
            // Close sidebar when clicking outside
            if (sidebar.classList.contains('open')) {
                document.addEventListener('click', closeOutside);
            } else {
                document.removeEventListener('click', closeOutside);
            }
        }

        function closeOutside(e) {
            const sidebar = document.getElementById('licenseSidebar');
            const toggle = document.querySelector('.license-toggle');
            if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
                sidebar.classList.remove('open');
                document.removeEventListener('click', closeOutside);
            }
        }

        // --- LICENSE & PAYMENT SETUP ---
        let trialChars = 0;
        let trialStartTime = null;
        const MAX_TRIAL_CHARS = 1000;
        const MAX_TRIAL_MS = 5 * 60 * 1000; // 5 minutes
        let isPremium = false; // Updated by backend checkSubscription

        // Toss Payments Client Key (Test)
        const clientKey = 'test_ck_D5bZzMqlcwBa29KGRJg8W480u0J9';
        const tossPayments = TossPayments(clientKey);

        let recognition = null, isRecognizing = false, videoStream = null, capturedImages = [], currentModalImage = null;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) document.getElementById('warning').classList.add('show');

        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }
        function getTimeString() { return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
        function getDateTimeString() { return new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-'); }

        // --- CONFIGURATION ---
        const BACKEND_URL = 'https://translator-backend-258115702573.asia-northeast3.run.app'; // Cloud Run Service URL
        const firebaseConfig = {
            apiKey: "AIzaSyBkR6Tu6dDyAArQf2mrs7Tb7h97pfjjCFs",
            authDomain: "internation-conference-helper.firebaseapp.com",
            projectId: "internation-conference-helper",
            storageBucket: "internation-conference-helper.firebasestorage.app",
            messagingSenderId: "258115702573",
            appId: "1:258115702573:web:96731227a9dae2445e4da4",
            measurementId: "G-6E1XKPCN6T"
        };
        // ---------------------

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        let currentUser = null;

        firebase.auth().onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-info').style.display = 'block';
                document.getElementById('loginModal').classList.remove('show');
                showToast('âœ… Logged in: ' + user.email);
            } else {
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('loginModal').classList.add('show');
            }
        });

        function loginWithGoogle() {
            console.log("Attempting Google Login...");
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then((result) => {
                    console.log("Login Success:", result.user.email);
                })
                .catch((e) => {
                    console.error("Login Error:", e);
                    alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + e.message + "\n\n(íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜, Firebase ì½˜ì†”ì—ì„œ ë„ë©”ì¸ ìŠ¹ì¸ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)");
                });
        }

        function logout() {
            firebase.auth().signOut();
        }

        async function translateText(text, targetLang) {
            if (!currentUser) return text;
            try {
                const token = await currentUser.getIdToken();
                const response = await fetch(`${BACKEND_URL}/translate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ text, targetLang })
                });

                if (!response.ok) {
                    if (response.status === 403) {
                        const err = await response.json();
                        showToast('âš ï¸ ' + (err.error || 'License invalid'));
                        return text + ' (License Error)';
                    }
                    throw new Error('Server Error');
                }

                const data = await response.json();
                return data.translatedText;
            } catch (e) {
                console.error(e);
                return text;
            }
        }

        async function startCamera() {
            if (!document.getElementById('cameraToggle').checked) { document.getElementById('videoWrapper').style.minHeight = '100px'; return true; }
            try {
                const facingMode = document.getElementById('cameraFacing').value;
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode, width: 1280, height: 720 }, audio: false });
                document.getElementById('videoElement').srcObject = videoStream;
                document.getElementById('videoWrapper').style.minHeight = '200px';
                return true;
            } catch (e) { showToast('Camera permission required'); return true; }
        }

        function stopCamera() { if (videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; document.getElementById('videoElement').srcObject = null; } }

        function captureWithSubtitle() {
            const video = document.getElementById('videoElement');
            const subtitleEl = document.getElementById('subtitleText');
            const canvas = document.getElementById('captureCanvas');
            const ctx = canvas.getContext('2d');
            if (!videoStream || video.videoWidth === 0) { showToast('Please start camera first'); return; }
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const subtitleText = subtitleEl.textContent;
            if (subtitleText && subtitleText !== 'Press Start button' && subtitleText !== 'Waiting for speech...') {
                const fontSize = Math.max(24, canvas.width / 25);
                ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
                const maxWidth = canvas.width * 0.9;
                let lines = [], currentLine = '';
                for (let char of subtitleText) {
                    const testLine = currentLine + char;
                    if (ctx.measureText(testLine).width > maxWidth && currentLine !== '') { lines.push(currentLine); currentLine = char; }
                    else currentLine = testLine;
                }
                lines.push(currentLine);
                const lineHeight = fontSize * 1.4, padding = 20;
                const boxHeight = lines.length * lineHeight + padding * 2;
                const boxY = canvas.height - boxHeight - 30;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
                ctx.beginPath(); ctx.roundRect(canvas.width * 0.03, boxY, canvas.width * 0.94, boxHeight, 12); ctx.fill();
                ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                lines.forEach((line, i) => ctx.fillText(line, canvas.width / 2, boxY + padding + (i + 0.5) * lineHeight));
                ctx.font = `${fontSize * 0.5}px -apple-system, sans-serif`;
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)'; ctx.textAlign = 'right';
                ctx.fillText(getTimeString(), canvas.width - 20, 30);
            }
            const imageData = canvas.toDataURL('image/png');
            capturedImages.push({ id: Date.now(), image: imageData, subtitle: subtitleText, time: getTimeString() });
            updateGallery();
            showToast('ğŸ“¸ Captured with subtitle!');
        }

        function updateGallery() {
            const gallery = document.getElementById('galleryGrid');
            document.getElementById('captureCount').textContent = capturedImages.length;
            if (capturedImages.length === 0) { gallery.innerHTML = '<div class="gallery-empty">No captures yet</div>'; return; }
            gallery.innerHTML = capturedImages.map((item, i) => `<div class="gallery-item" onclick="openModal(${i})"><img src="${item.image}" alt="Capture ${i + 1}"><button class="delete-btn" onclick="event.stopPropagation(); deleteCapture(${i})">Ã—</button></div>`).join('');
        }

        function openModal(i) { currentModalImage = capturedImages[i]; document.getElementById('modalImage').src = currentModalImage.image; document.getElementById('imageModal').classList.add('show'); }
        function closeModal() { document.getElementById('imageModal').classList.remove('show'); currentModalImage = null; }
        function downloadModalImage() {
            if (!currentModalImage) return;
            const a = document.createElement('a'); a.download = `conference_capture_${getDateTimeString()}.png`; a.href = currentModalImage.image;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('ğŸ’¾ Image downloaded!');
        }
        function deleteCapture(i) { capturedImages.splice(i, 1); updateGallery(); showToast('ğŸ—‘ï¸ Deleted'); }
        function clearGallery() { if (capturedImages.length === 0) { showToast('No images to clear'); return; } if (confirm('Delete all captured images?')) { capturedImages = []; updateGallery(); showToast('ğŸ—‘ï¸ All images cleared'); } }

        function requestPayment(amount, orderName) {
            if (!tossPayments) return showToast('Payment system loading...');
            if (!currentUser && amount === 100000) {
                alert('Please login first to link the license to your account.');
                loginWithGoogle();
                return;
            }
            const uid = currentUser ? currentUser.uid : 'anon';
            // Order ID format: ORDER-UID-TIMESTAMP
            const orderId = `ORDER-${uid}-${Date.now()}`;

            tossPayments.requestPayment('ì¹´ë“œ', {
                amount: amount,
                orderId: orderId,
                orderName: orderName,
                customerName: currentUser ? currentUser.email : 'Guest',
                successUrl: window.location.origin + '/conference-helper/success.html', // Fixed for GitHub Pages path
                failUrl: window.location.origin + '/conference-helper/index.html',
            });
        }

        function initSpeechRecognition() {
            if (!SpeechRecognition) return null;
            const recognition = new SpeechRecognition();
            recognition.continuous = true; recognition.interimResults = true;
            recognition.lang = document.getElementById('recognitionLang').value;
            recognition.onstart = () => { isRecognizing = true; document.getElementById('statusDot').classList.add('active'); document.getElementById('statusText').textContent = 'Listening...'; document.getElementById('startBtn').style.display = 'none'; document.getElementById('stopBtn').style.display = 'flex'; };
            recognition.onend = () => { if (isRecognizing) { try { recognition.start(); } catch (e) { } } else { document.getElementById('statusDot').classList.remove('active'); document.getElementById('statusText').textContent = 'Ready'; document.getElementById('startBtn').style.display = 'flex'; document.getElementById('stopBtn').style.display = 'none'; } };
            recognition.onerror = (e) => { if (e.error === 'not-allowed') showToast('Microphone permission required'); };
            recognition.onresult = async (e) => {
                const subtitleEl = document.getElementById('subtitleText');
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) { if (e.results[i].isFinal) final += e.results[i][0].transcript; else interim += e.results[i][0].transcript; }

                // --- TRIAL LIMIT CHECK ---
                if (!isPremium && final.length > 0) {
                    if (!trialStartTime) trialStartTime = Date.now();
                    // 1. Time Limit
                    if (Date.now() - trialStartTime > MAX_TRIAL_MS) {
                        stopAll();
                        alert("â³ ë¬´ë£Œ ì²´í—˜ ì‹œê°„(5ë¶„)ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nê³„ì† ì‚¬ìš©í•˜ì‹œë ¤ë©´ ë¼ì´ì„ ìŠ¤ë¥¼ êµ¬ë§¤í•´ì£¼ì„¸ìš”.");
                        requestPayment(100000, 'ê°œì¸ ë¼ì´ì„ ìŠ¤');
                        return;
                    }
                    // 2. Char Limit
                    trialChars += final.length;
                    if (trialChars > MAX_TRIAL_CHARS) {
                        stopAll();
                        alert("ğŸ“ ë¬´ë£Œ ì²´í—˜ ê¸€ì ìˆ˜(1,000ì)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.\n\nê³„ì† ì‚¬ìš©í•˜ì‹œë ¤ë©´ ë¼ì´ì„ ìŠ¤ë¥¼ êµ¬ë§¤í•´ì£¼ì„¸ìš”.");
                        requestPayment(100000, 'ê°œì¸ ë¼ì´ì„ ìŠ¤');
                        return;
                    }
                }
                // -------------------------

                if (final) {
                    subtitleEl.textContent = final; subtitleEl.className = 'subtitle-text final';
                    const translated = await translateText(final, document.getElementById('translateLang').value);
                    addToTranscript(final, translated);
                    setTimeout(() => { if (subtitleEl.textContent === final) { subtitleEl.className = 'subtitle-text empty'; subtitleEl.textContent = 'Waiting for speech...'; } }, 5000);
                } else if (interim) { subtitleEl.textContent = interim; subtitleEl.className = 'subtitle-text interim'; }
            };
            return recognition;
        }

        async function startAll() { await startCamera(); startRecognition(); showToast('â–¶ï¸ Started'); }
        function stopAll() { stopRecognition(); stopCamera(); showToast('â¹ï¸ Stopped'); }
        function startRecognition() { if (!recognition) recognition = initSpeechRecognition(); if (recognition) { recognition.lang = document.getElementById('recognitionLang').value; try { recognition.start(); } catch (e) { } } }
        function stopRecognition() { isRecognizing = false; if (recognition) try { recognition.stop(); } catch (e) { } const s = document.getElementById('subtitleText'); s.className = 'subtitle-text empty'; s.textContent = 'Press Start button'; }

        function addToTranscript(original, translated) {
            const box = document.getElementById('transcriptBox');
            const item = document.createElement('div'); item.className = 'transcript-item';
            item.innerHTML = `<div class="transcript-time">${getTimeString()}</div><div class="transcript-original">${original}</div><div class="transcript-translated">${translated}</div>`;
            box.appendChild(item); box.scrollTop = box.scrollHeight;
        }
        function clearTranscript() { document.getElementById('transcriptBox').innerHTML = ''; showToast('ğŸ—‘ï¸ Log cleared'); }
        function saveTranscript() {
            const items = document.getElementById('transcriptBox').querySelectorAll('.transcript-item');
            if (items.length === 0) { showToast('No records to save'); return; }
            let content = '=== Conference Helper - Translation Log ===\n';
            content += `Saved: ${new Date().toLocaleString()}\nRecognition: ${document.getElementById('recognitionLang').selectedOptions[0].text}\nTranslation: ${document.getElementById('translateLang').selectedOptions[0].text}\n==========================================\n\n`;
            items.forEach(item => { content += `[${item.querySelector('.transcript-time').textContent}]\nOriginal: ${item.querySelector('.transcript-original').textContent}\nTranslated: ${item.querySelector('.transcript-translated').textContent}\n\n`; });
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type: 'text/plain;charset=utf-8' })); a.download = `conference_log_${getDateTimeString()}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            showToast('ğŸ’¾ Log saved');
        }

        document.getElementById('recognitionLang').addEventListener('change', () => { if (isRecognizing && recognition) { recognition.stop(); recognition = null; setTimeout(() => { recognition = initSpeechRecognition(); if (recognition) recognition.start(); showToast('ğŸŒ Language changed'); }, 200); } });
        document.getElementById('cameraFacing').addEventListener('change', async () => { if (videoStream) { stopCamera(); await startCamera(); } });
        document.getElementById('imageModal').addEventListener('click', (e) => { if (e.target.id === 'imageModal') closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        window.onbeforeunload = stopAll;
        if ('serviceWorker' in navigator && !location.hostname.includes('claudeusercontent')) navigator.serviceWorker.register('sw.js').catch(e => { });
    </script>
</body>

</html>